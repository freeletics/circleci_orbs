description: |
  Prepares CI workflow for Android builds later in this workflow. Followup jobs
  should not do any checkout, but attach workspace and restore Android and Gradle caches.

parameters:
  git_cache_version:
    description: "Git cache key (example \"v2\"). Could be used to invalidate cache."
    type: string
    default: "v2"
  android_cache_version:
    description: "Android sdk cache key (example \"v2\"). Could be used to invalidate cache."
    type: string
    default: "v3"
  gradle_cache_version:
    description: "Gradle cache key (example \"v2\"). Could be used to invalidate cache."
    type: string
    default: "v6"
  gradle_cache_modifier:
    description: "Optional Gradle cache modifier. Useful to create several caches for the same dependencies file."
    type: string
    default: ""
  dependencies_file:
    description: "Path to the file that defines all project dependencies and their versions."
    type: string
  sync_dependencies:
    description: "Steps to sync all Android and Gradle dependencies."
    type: steps
    default: []

executor: android-medium

steps:
  - checkout-from-git-cache:
      cache_version: << parameters.git_cache_version >>
  - run:
      name: Removing .git folder
      command: rm -rf .git/
  - persist_to_workspace:
      root: .
      paths:
        - .
  - restore-android-sdk-cache:
      cache_version: << parameters.android_cache_version >>
      dependencies_file: << parameters.dependencies_file >>
  - restore-gradle-cache:
      cache_version: << parameters.gradle_cache_version >>
      cache_modifier: << parameters.gradle_cache_modifier >>
      dependencies_file: << parameters.dependencies_file >>
  - steps: << parameters.sync_dependencies >>
  - save-android-sdk-cache:
      cache_version: << parameters.android_cache_version >>
      dependencies_file: << parameters.dependencies_file >>
  - save-gradle-cache:
      cache_version: << parameters.gradle_cache_version >>
      cache_modifier: << parameters.gradle_cache_modifier >>
      dependencies_file: << parameters.dependencies_file >>
