description: |
  Sanity check to make sure you can push a container image.

    * check that $DOCKER_LOGIN and $DOCKER_PASSWORD environment variables are set
    * run docker login to ensure that you can push the built image
parameters:
  registry:
    description: Name of registry to use. Defaults to docker.io.
    type: string
    default: docker.io
steps:
  - run:
      name: "kaniko-publish: Simulate Docker Login"
      command: |
        check_var() {
          if [[ -z "${1}" ]]; then
            echo "${!1@} is not set, will not be able to push image." 1>&2
            exit 1
          fi
        }

        if [ "<< parameters.registry >>" = "docker.io"]; then
          check_var "${DOCKER_LOGIN}"
          check_var "${DOCKER_PASSWORD}"

          auth=$(printf "${DOCKER_LOGIN}:${DOCKER_PASSWORD}" | base64)
          cat \<< JSON > /kaniko/.docker/config.json
          {
            "auths": {
              "https://index.docker.io/v1/": {
                "auth": "${auth}"
              }
            }
          }
          JSON
        elif [[ "<< parameters.registry >>" ~= "*." =~ [0-9]+\.dkr\.ecr\..*\.amazonaws\.com ]]; then
          check_var "${AWS_ACCESS_KEY_ID}"
          check_var "${AWS_SECRET_ACCESS_KEY}"

          echo '{ "credsStore": "ecr-login" }' > /kaniko/.docker/config.json
        else
          cat \<< EOF
            Docker Registry not yet supported, please fill an issue/feature request on GitHub or send a PR.

            Alternatively, you can disable this setting the check to false,
              and use the before_build parameter to configure your registry properly.
          EOF
          exit 1
        fi
